// <copyright file="TriggerSendSingleAttachmentToLogicApp.cs" company="">
// Copyright (c) 2018 All Rights Reserved
// </copyright>
// <author></author>
// <date>8/3/2018 4:42:35 PM</date>
// <summary>Implements the TriggerSendSingleAttachmentToLogicApp Plugin.</summary>
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.1
// </auto-generated>
using System.Activities;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Workflow;
using Defra.Lp.Common.SharePoint;

namespace Defra.Lp.Workflows
{
    /// <summary>
    /// This code activity is used to trigger the SendSingleAttachmentToLogicApp
    /// plugin and allows us to process annotations, emails or activitymimeattachments
    /// separately. 
    /// </summary>
    public class TriggerSendFileToLogicApp : CodeActivity
    {
        protected override void Execute(CodeActivityContext executionContext)
        {
            var tracingService = executionContext.GetExtension<ITracingService>();
            var context = executionContext.GetExtension<IWorkflowContext>();
            var serviceFactory = executionContext.GetExtension<IOrganizationServiceFactory>();
            var service = serviceFactory.CreateOrganizationService(context.UserId);
            var adminService = serviceFactory.CreateOrganizationService(null);

            var azureInterface = new AzureInterface(adminService, service, tracingService);

            // Using an action because we don't know how many attachments we'll have. Could take more 
            // than process limit of 2 minutes so using action trigger async plugin.
            // Additionally, files larger than approx 20MB cause problems with custom workflow code
            // activity if passing the whole file in the context.
            azureInterface.SendFileToSharePointActionRequest(context.PrimaryEntityName, context.PrimaryEntityId);
        }
    }
}