// <copyright file="CompaniesHouseValidation.cs" company="">
// Copyright (c) 2017 All Rights Reserved
// </copyright>
// <author></author>
// <date>12/4/2017 12:00:54 PM</date>
// <summary>Implements the CompaniesHouseValidation Plugin.</summary>
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.1
// </auto-generated>

using System;
using System.Activities;
using System.Collections.Generic;
using System.Net;
using CardPayments;
using CardPayments.Model;
using Core.Configuration;
using Defra.Lp.Core.CardPayments.Workflow.Constants;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Workflow;

namespace Defra.Lp.Core.CardPayments.Workflow.CodeActivities.Abstract
{

    /// </summary>    
    public class PaymentWorkflowActivityBase : WorkFlowActivityBase
    { 
        // Input Parameters

        [Input("Configuration Prefix")]
        public InArgument<string> ConfigurationPrefix { get; set; }

        // Output Parameters

        [RequiredArgument]
        [Output("PaymentId")]
        public OutArgument<string> PaymentId { get; set; }

        [RequiredArgument]
        [Output("PaymentStatus")]
        public OutArgument<string> PaymentStatus { get; set; }

        [Output("PaymentFinished")]
        public OutArgument<bool> PaymentFinished { get; set; }

        [RequiredArgument]
        [Output("PaymentNextUrlHref")]
        public OutArgument<string> PaymentNextUrlHref { get; set; }

        [Output("PaymentNextUrlMethod")]
        public OutArgument<string> PaymentNextUrlMethod { get; set; }

        [Output("PaymentCancelUrlHref")]
        public OutArgument<string> PaymentCancelUrlHref { get; set; }

        [Output("PaymentCancelUrlMethod")]
        public OutArgument<string> PaymentCancelUrlMethod { get; set; }

        [Output("PaymentProvider")]
        public OutArgument<string> PaymentProvider { get; set; }

        protected void PrepareOutputParameters(CodeActivityContext executionContext, BasePaymentResponse apiResponse, ITracingService tracingService)
        {
            tracingService.Trace("PrepareOutputParameters()");

            var status = string.IsNullOrEmpty(apiResponse.state?.status) ? string.Empty : apiResponse.state?.status;
            tracingService.Trace("PrepareOutputParameters() status = {0}", status);
            PaymentStatus.Set(executionContext, status);

            var id = string.IsNullOrEmpty(apiResponse.payment_id) ? string.Empty : apiResponse.payment_id;
            tracingService.Trace("PrepareOutputParameters() payment_id = {0}", id);
            PaymentId.Set(executionContext, id);

            var finished = (apiResponse.state?.finished == null) ? false : apiResponse.state?.finished;
            tracingService.Trace("PrepareOutputParameters() finished = {0}", apiResponse.state?.finished);
            PaymentFinished.Set(executionContext, apiResponse.state?.finished);

            var href = string.IsNullOrEmpty(apiResponse._links?.next_url?.href) ? string.Empty : apiResponse._links?.next_url?.href;
            tracingService.Trace("PrepareOutputParameters() apiResponse._links?.next_url.href) = {0}", href);
            PaymentNextUrlHref.Set(executionContext, href);

            var method = string.IsNullOrEmpty(apiResponse._links?.next_url?.method) ? string.Empty : apiResponse._links?.next_url?.method;
            tracingService.Trace("PrepareOutputParameters() apiResponse._links?.next_url.method = {0}", method);
            PaymentNextUrlMethod.Set(executionContext, method);

            var cancelhref = string.IsNullOrEmpty(apiResponse._links?.cancel?.href) ? string.Empty : apiResponse._links?.cancel?.href;
            tracingService.Trace("PrepareOutputParameters() cancel.href = {0}", cancelhref);
            PaymentCancelUrlHref.Set(executionContext, cancelhref);

            var cancelmethod = string.IsNullOrEmpty(apiResponse._links?.cancel?.method) ? string.Empty : apiResponse._links?.cancel?.method;
            tracingService.Trace("PrepareOutputParameters() cancel.method = {0}", cancelmethod);
            PaymentCancelUrlMethod.Set(executionContext, cancelmethod);

            var provider = string.IsNullOrEmpty(apiResponse.payment_provider) ? string.Empty : apiResponse.payment_provider;
            tracingService.Trace("PrepareOutputParameters() payment_provider = {0}", provider);
            PaymentProvider.Set(executionContext, provider);
        }

        protected RestServiceConfiguration RetrieveCardPaymentServiceConfiguration(CodeActivityContext executionContext, string configurationPrefix)
        {
            if (string.IsNullOrWhiteSpace(configurationPrefix))
            {
                configurationPrefix = String.Empty;
            }

            IOrganizationServiceFactory factory = (IOrganizationServiceFactory)executionContext.GetExtension<IOrganizationServiceFactory>();
            IOrganizationService service = factory.CreateOrganizationService(null);

            // Read the settings
            IDictionary<string, string> configSettings = service.GetConfigurationStringValues(
                 $"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.ApiKey}",
                 $"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.TargetUrl}",
                 $"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.TargetHost}",
                 $"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.SecurityProtocol}",
                 $"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.SecurityHeader}");

            // Parse the settings
            SecurityProtocolType protocolType;
            Enum.TryParse(
                configSettings[$"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.SecurityProtocol}"],
                out protocolType);

            RestServiceConfiguration config = new RestServiceConfiguration
            {
                ApiKey = configSettings[$"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.ApiKey}"],
                SecurityHeader = configSettings[$"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.SecurityHeader}"],
                SecurityProtocol = protocolType,
                TargetHost = configSettings[$"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.TargetHost}"],
                TargetUrl = configSettings[$"{configurationPrefix}{CardPaymentServiceSecureConfigurationKeys.TargetUrl}"]
            };
            return config;
        }
    }
}